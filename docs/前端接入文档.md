# 前端接入文档

## 一、基础配置

### 1.1 API 基础地址
```
基础URL: http://your-server-domain/api
```

### 1.2 请求格式
- **Content-Type**: `application/json`
- **字符编码**: `UTF-8`

### 1.3 响应格式
所有接口统一返回格式：
```json
{
  "code": 0,           // 状态码，0表示成功
  "data": {},         // 数据对象
  "message": "ok"     // 提示信息
}
```

**状态码说明**：
- `0`: 成功
- `40000`: 请求参数错误
- `40101`: 未登录或无权限
- `40300`: 禁止访问
- `40400`: 请求数据不存在
- `50000`: 系统内部异常
- `50001`: 操作失败

---

## 二、Sa-Token JWT 认证（重要）

### 2.1 JWT Token 配置信息

根据后端配置，JWT Token 的携带方式如下：

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Token名称 | `Authorization` | 请求头字段名 |
| Token前缀 | `Bearer ` | 注意：Bearer后面有一个空格 |
| 读取位置 | Header | 从请求头读取，不从Cookie读取 |
| Token类型 | JWT | JSON Web Token |
| 有效期 | 900秒（15分钟） | Token过期时间 |

### 2.2 JWT Token 携带方式

**必须在每个需要认证的请求头中携带 JWT Token**，格式如下：

```
Authorization: Bearer <your-jwt-token>
```

**注意**：
- `Bearer` 和 Token 之间**必须有一个空格**
- Token 名称是 `Authorization`（注意大小写）
- 不要使用 `token`、`accessToken` 等其他字段名

### 2.3 获取 JWT Token

通过登录接口获取 Token：

**请求示例**：
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "your_username",
  "password": "your_password"
}
```

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "message": "ok"
}
```

**保存 Token**：
```javascript
// 登录成功后，保存 accessToken
localStorage.setItem('token', response.data.accessToken);
```

### 2.4 在请求中携带 Token

#### 方式一：使用 Axios 拦截器（推荐）

```javascript
import axios from 'axios';

// 创建 axios 实例
const api = axios.create({
  baseURL: 'http://your-server-domain/api',
  timeout: 10000
});

// 请求拦截器：自动添加 Token
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      // 注意：Bearer 后面有一个空格
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 响应拦截器：处理 Token 过期
api.interceptors.response.use(
  (response) => {
    return response.data; // 直接返回 data 部分
  },
  (error) => {
    if (error.response?.status === 401) {
      // Token 过期或无效，跳转到登录页
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

#### 方式二：手动在每个请求中添加

```javascript
// 使用 fetch
fetch('/api/bank', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}` // 注意空格
  },
  body: JSON.stringify(data)
});

// 使用 axios
axios.post('/api/bank', data, {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}` // 注意空格
  }
});
```

### 2.5 Token 刷新

当 Token 即将过期时，可以使用刷新接口获取新的 Token：

```javascript
// 刷新 Token
const refreshToken = async () => {
  try {
    const response = await api.post('/api/auth/refresh');
    const newToken = response.data.accessToken;
    localStorage.setItem('token', newToken);
    return newToken;
  } catch (error) {
    // 刷新失败，跳转登录
    localStorage.removeItem('token');
    window.location.href = '/login';
  }
};
```

### 2.6 登出

登出时需要调用登出接口，并清除本地 Token：

```javascript
const logout = async () => {
  try {
    await api.post('/api/auth/logout');
  } finally {
    localStorage.removeItem('token');
    window.location.href = '/login';
  }
};
```

---

## 三、请求注意事项

### 3.1 需要认证的接口

以下接口**必须携带 JWT Token**：

- `POST /api/bank` - 创建题库（需要管理员权限）
- `PUT /api/bank/{id}` - 更新题库（需要管理员权限）
- `POST /api/auth/logout` - 用户登出
- `POST /api/auth/refresh` - 刷新Token
- `GET /api/auth/me` - 获取当前用户信息

### 3.2 无需认证的接口

以下接口**不需要携带 JWT Token**：

- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/bank` - 查询题库列表
- `GET /api/bank/{id}` - 查询题库详情

### 3.3 权限说明

- **普通用户**：只能查询题库，不能创建/更新
- **管理员（ADMIN）**：可以创建和更新题库

### 3.4 请求头示例

**需要认证的请求**：
```http
POST /api/bank HTTP/1.1
Host: your-server-domain
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**无需认证的请求**：
```http
GET /api/bank?current=1&size=10 HTTP/1.1
Host: your-server-domain
Content-Type: application/json
```

---

## 四、常见问题

### 4.1 Token 格式错误

**错误示例**：
```
Authorization: Bearer<token>  // ❌ 缺少空格
Authorization: bearer <token>  // ❌ Bearer 大小写错误
Authorization: <token>         // ❌ 缺少 Bearer 前缀
```

**正确示例**：
```
Authorization: Bearer <token>  // ✅ 正确格式
```

### 4.2 Token 过期处理

当收到 `401` 状态码时，说明 Token 已过期或无效：

```javascript
// 响应拦截器处理
if (error.response?.status === 401) {
  // 清除过期 Token
  localStorage.removeItem('token');
  // 跳转登录页
  router.push('/login');
}
```

### 4.3 跨域问题

后端已配置 CORS，支持跨域请求。如果遇到跨域问题，请检查：

1. 请求头是否包含 `Authorization`
2. 是否使用了正确的请求方法（GET、POST、PUT、DELETE等）
3. 是否设置了 `Content-Type: application/json`

### 4.4 权限不足

如果收到 `403` 状态码，说明当前用户权限不足：

```json
{
  "code": 40300,
  "message": "需要管理员权限"
}
```

**解决方案**：确保当前登录用户具有 `ADMIN` 角色。

---

## 五、完整示例

### 5.1 登录并保存 Token

```javascript
// 登录
const login = async (username, password) => {
  const response = await axios.post('/api/auth/login', {
    username,
    password
  });
  
  if (response.data.code === 0) {
    const token = response.data.data.accessToken;
    localStorage.setItem('token', token);
    return token;
  } else {
    throw new Error(response.data.message);
  }
};
```

### 5.2 创建题库（需要管理员权限）

```javascript
// 创建题库
const createBank = async (bankData) => {
  const token = localStorage.getItem('token');
  
  const response = await axios.post('/api/bank', {
    name: bankData.name,
    description: bankData.description,
    tagList: bankData.tagList || [],
    submitForReview: bankData.submitForReview || false
  }, {
    headers: {
      'Authorization': `Bearer ${token}` // 注意空格
    }
  });
  
  return response.data;
};
```

### 5.3 查询题库列表（无需认证）

```javascript
// 查询题库列表
const getBankList = async (current = 1, size = 10, name = null, tag = null) => {
  const params = { current, size };
  if (name) params.name = name;
  if (tag) params.tag = tag;
  
  const response = await axios.get('/api/bank', { params });
  return response.data;
};
```

---

## 六、最佳实践

1. **统一使用 Axios 拦截器**：避免在每个请求中重复添加 Token
2. **Token 过期自动处理**：在响应拦截器中统一处理 401 错误
3. **Token 安全存储**：使用 `localStorage` 或 `sessionStorage` 存储 Token
4. **错误处理**：统一处理接口错误，给用户友好的提示
5. **请求重试**：Token 过期时，可以尝试刷新 Token 后重试请求

---

## 七、调试技巧

### 7.1 检查 Token 是否携带

在浏览器开发者工具的 Network 面板中，查看请求头：

```
Request Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 7.2 查看 Token 内容（仅用于调试）

JWT Token 由三部分组成，用 `.` 分隔：
```
header.payload.signature
```

可以在 [jwt.io](https://jwt.io) 解码查看 Token 内容（不包含签名验证）。

---

**重要提醒**：
- ✅ Token 格式：`Bearer <token>`（注意空格）
- ✅ Token 字段名：`Authorization`（注意大小写）
- ✅ Token 有效期：15分钟，过期后需要刷新或重新登录
- ✅ 管理员操作需要 `ADMIN` 角色权限

